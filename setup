# If _OLDPATH set PATH to it
# sort of like deactivate
if [ -n "$_OLDPATH" ]
then
    export PATH=$_OLDPATH
fi

# This gives us the current directory that this script is in
THIS="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Deactivate if possible
deactivate 2>/dev/null

# Activate vdbapps for now, but soon we will remove this in favor
# of git submodules for all the necessary apps
. /home/EIDRUdata/programs/vdbapps/bin/activate

CWD=$(pwd)
# Compile samtools
if [ ! -e ${THIS}/samtools/samtools ]
then
    cd ${THIS}/htslib
    make
    cd ${THIS}/samtools
    make
    cd $CWD
fi

# Compile bwa
if [ ! -e ${THIS}/bwa/bwa ]
then
    cd ${THIS}/bwa
    make
    cd $CWD
fi

# Some manpage setup
if [ ! -d ${THIS}/man1 ]
then
    mkdir -p ${THIS}/man1
    # Find all the actual manpages and link them into the man1 directory
    find . -type f -name '*.1' | while read f
    do
        # Manpages start with .TH
        head -1 "$f" | grep -q '^.TH'
        if [ $? -eq 0 ]
        then
            path_to="$(cd $(dirname "$f") && pwd)/$(basename "$f")"
            ln -s "$path_to" "${THIS}/man1/$(basename "$f")"
        fi
    done
fi

# Remember the old path
_OLDPATH=$PATH
# Setup the path to include bwa and samtools that we just compiled
export PATH=${THIS}:${THIS}/BamCoverage:${THIS}/bwa:${THIS}/samtools:$PATH

# Remember the old manpath
_OLDMANPATH=$(manpath)
# Setup the manpath for bwa and samtools
export MANPATH=$(manpath):${THIS}

# TODO
# add deactivate function in this file
